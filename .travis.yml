language: python
sudo: required
services:
  - docker
  - xvfb
python:
  - '3.9.21'
cache:
  directories:
    - '$HOME/.cache/pip'
before_install:
  - sudo rm -f /etc/boto.cfg
  - export CHROME_BIN=chromium-browser
  - export DISPLAY=:99.0
  - pip install --upgrade pip
  - ulimit -u 16384  # Increase process/thread limit
  - ulimit -n 4096   # Increase open file limit
install:
  - pip install awscli==1.18.66 flake8==3.8.2 coveralls
jobs:
  include:
    - name: Lint
      script:
        - flake8 ./ || travis_terminate 1
    - name: NodeJS
      script:
        - docker-compose run nodejs bash -c "gulp dev && karma start --single-run && gulp staging" || travis_terminate 1
    - name: Django build
      script:
        - docker-compose run -e DJANGO_SETTINGS_MODULE=settings.test django pytest --cov . --cov-config .coveragerc || travis_terminate 1
      before_cache:
        - rm -f $HOME/.cache/pip/log/debug.log
      after_success:
        - bash <(curl -s https://codecov.io/bash)
        - coveralls --rcfile=.coveragerc
    - name: Deploy
      if: branch = main AND type != pull_request
      script:
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin || travis_terminate 1
        - docker-compose build || travis_terminate 1
      before_cache:
        - rm -f $HOME/.cache/pip/log/debug.log
      after_success:
        - ./scripts/deployment/push.sh || travis_terminate 1
        - ./scripts/deployment/deploy.sh auto_deploy || travis_terminate 1

notifications:
  email:
    on_success: change
    on_failure: always
  slack: cloudcv:gy3CGQGNXLwXOqVyzXGZfdea
