# Generated by Django 2.2.20 on 2025-07-09 15:00

from django.db import migrations, models
import uuid


def fix_duplicate_github_fields(apps, schema_editor):
    """
    Fix duplicate empty github_repository and github_branch combinations
    by assigning unique values to challenges that don't have GitHub info.
    """
    Challenge = apps.get_model('challenges', 'Challenge')
    
    # Find challenges with empty github_repository and github_branch
    challenges_with_empty_github = Challenge.objects.filter(
        github_repository__in=['', None],
        github_branch__in=['', None]
    )
    
    # Update each challenge to have unique github fields
    for challenge in challenges_with_empty_github:
        # For non-GitHub challenges, create a unique identifier
        unique_id = str(uuid.uuid4())[:8]
        challenge.github_repository = f"local-challenge-{challenge.id}-{unique_id}"
        challenge.github_branch = "main"
        challenge.save()


def reverse_fix_duplicate_github_fields(apps, schema_editor):
    """
    Reverse the fix by setting github fields back to empty for local challenges.
    """
    Challenge = apps.get_model('challenges', 'Challenge')
    
    # Find challenges that were created as local challenges
    local_challenges = Challenge.objects.filter(
        github_repository__startswith='local-challenge-'
    )
    
    for challenge in local_challenges:
        challenge.github_repository = ''
        challenge.github_branch = ''
        challenge.save()


class Migration(migrations.Migration):

    dependencies = [
        ('challenges', '0112_challenge_sqs_retention_period'),
    ]

    operations = [
        migrations.AddField(
            model_name='challenge',
            name='github_branch',
            field=models.CharField(blank=True, default='', max_length=200, null=True),
        ),
        migrations.RunPython(
            fix_duplicate_github_fields,
            reverse_fix_duplicate_github_fields,
        ),
        migrations.AlterUniqueTogether(
            name='challenge',
            unique_together={('github_repository', 'github_branch')},
        ),
    ]
